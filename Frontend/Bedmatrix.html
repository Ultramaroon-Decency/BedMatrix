<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BedMatrix | Hospital Bed & Blood Bank Tracker</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    :root {
      --primary-color: #3B82F6;
      --secondary-color: #10B981;
      --bg-light: #F9FAFB;
      --text-dark: #1F2937;
      --text-gray: #4B5563;
      --white: #FFFFFF;
    }

    * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter', sans-serif; }
    html { scroll-behavior: smooth; }
    body { background: var(--bg-light); color:var(--text-dark); }

    nav {
      background: var(--white);
      padding:1rem 2rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
      position: sticky;
      top:0;
      z-index:1000;
    }
    nav h1 { color: var(--primary-color); font-weight:700; font-size:1.6rem; }
    nav ul { list-style:none; display:flex; gap:1.2rem; align-items:center; }
    nav ul li a { text-decoration:none; color: var(--text-dark); font-weight:500; cursor:pointer;}
    nav ul li a:hover { color: var(--primary-color); }

    section { padding: 3rem 2rem; }
    h2.section-title { text-align:center; font-size:2.2rem; font-weight:700; margin-bottom:1.5rem; color:var(--text-dark); }

    /* Hero */
    .hero { text-align:center; padding:4rem 2rem; background: linear-gradient(to right,#E0F2FE,#F0FDFA);}
    .hero h2 { font-size:2.4rem; font-weight:700; color:var(--text-dark); }
    .hero p { max-width:780px; margin:0.8rem auto; color:var(--text-gray); font-size:1.05rem; }

    .hero button { background: var(--primary-color); color:white; padding:0.8rem 2rem; border:none; border-radius:8px; cursor:pointer; font-weight:600; }

    /* Features */
    .features-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:1.5rem; max-width:1200px; margin:0 auto;}
    .feature-card { background: var(--white); padding:1.5rem; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.05); text-align:center; transition: transform 0.28s ease, box-shadow 0.28s ease;}
    .feature-card:hover { transform:translateY(-6px); box-shadow:0 12px 30px rgba(0,0,0,0.08);}
    .feature-icon { width:56px; height:56px; margin-bottom:0.75rem; object-fit:contain; }
    .feature-title { font-size:1.1rem; font-weight:600; margin-bottom:0.45rem; color: var(--primary-color);}
    .feature-desc { font-size:0.95rem; color:var(--text-gray); }

    /* Dashboard Table */
    .dashboard table { width:100%; max-width:1100px; margin:0 auto; border-collapse:collapse; box-shadow:0 4px 20px rgba(0,0,0,0.05);}
    th,td { padding:0.9rem; text-align:center; border-bottom:1px solid #E5E7EB;}
    th { background: var(--primary-color); color:white; font-weight:600;}
    tr:hover { background:#F3F4F6; transition:0.2s;}
    .status { padding:0.35rem 0.7rem; border-radius:6px; font-weight:600; display:inline-block;}
    .available { background:#DCFCE7; color:#166534; }
    .fewleft { background:#FEF9C3; color:#92400E; }
    .full { background:#FEE2E2; color:#991B1B; }

    /* FAQ (hover reveal) */
    .faq-section { padding: 4rem 2rem; max-width: 900px; margin: auto; }
    .faq-intro { text-align: center; color: var(--text-gray); font-size: 1rem; margin-bottom: 2.5rem; }
    .faq-container { display: flex; flex-direction: column; gap: 1rem; }
    .faq-item { background: var(--white); border-radius: 10px; box-shadow: 0 4px 14px rgba(0,0,0,0.05); padding: 1.2rem 1.5rem; transition: all 0.3s ease; position: relative; overflow: hidden; cursor: pointer; }
    .faq-question { font-weight: 600; font-size: 1.05rem; color: var(--primary-color); }
    .faq-answer { margin-top: 0.7rem; color: var(--text-gray); font-size: 0.95rem; line-height: 1.5; max-height: 0; opacity: 0; transition: all 0.4s ease; }
    .faq-item:hover .faq-answer { max-height: 300px; opacity: 1; }
   /* Login */
    .login-form { max-width:400px; margin:2rem auto; padding:2rem; background: var(--white); border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.05);}
    .login-form input, .login-form button { width:100%; padding:0.8rem; margin:0.5rem 0; border-radius:8px; border:1px solid #D1D5DB; }
    .login-form button { background: var(--primary-color); color:white; border:none; cursor:pointer; }
    .login-form button:hover { background: #2563EB; transition:0.2s; }


    /* Search & Filter panel */
    .search-panel { max-width:1200px; margin:1.25rem auto; background:var(--white); padding:1rem; border-radius:12px; box-shadow:0 8px 30px rgba(2,6,23,.04); }
    .controls { display:flex; flex-wrap:wrap; gap:0.75rem; align-items:center; margin-bottom:0.75rem; }
    .search-input { flex:1; min-width:200px; padding:0.6rem 0.8rem; border:1px solid #E6EEF8; border-radius:8px; }
    .filters { display:flex; gap:0.75rem; align-items:center; }
    .filter-group { display:flex; flex-direction:column; min-width:140px; font-size:0.9rem; color:var(--text-gray); }
    .filter-label { font-size:0.8rem; color:var(--text-gray); margin-bottom:0.25rem; }
    select { padding:0.5rem; border-radius:8px; border:1px solid #E6EEF8; background:white; }

    .btn { background:var(--primary-color); color:white; border:none; padding:0.5rem 0.75rem; border-radius:8px; cursor:pointer; }

    .list-and-map { display:grid; grid-template-columns:360px 1fr; gap:1rem; margin-top:0.5rem; }
    .hospital-list { max-height:62vh; overflow:auto; padding-right:6px; display:flex; flex-direction:column; gap:0.6rem; }
    .h-card { background:linear-gradient(180deg,#fff,#fbfdff); padding:0.75rem; border-radius:10px; border:1px solid #EEF6FF; display:flex; justify-content:space-between; align-items:center; gap:0.5rem; cursor:pointer; }
    .h-left { display:flex; flex-direction:column; }
    .h-name { font-weight:600; color:var(--text-dark); }
    .h-wards { font-size:0.85rem; color:var(--text-gray); margin-top:6px; }
    .h-status { padding:0.25rem 0.6rem; border-radius:999px; font-weight:700; font-size:0.8rem; }
    
    /* Map */
    #map { width:100%; height:64vh; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); margin:0; }

    /* small screens */
    @media (max-width:920px){
      .list-and-map { grid-template-columns:1fr; }
      .hospital-list { order:2; max-height:40vh; }
      #map { order:1; height:42vh; }
    }

    /* Chatbot + other styles kept as-is */
    .chatbot-toggle { position:fixed; bottom:20px; right:20px; background:var(--secondary-color); color:white; border:none; border-radius:50%; width:60px; height:60px; font-size:1.6rem; cursor:pointer; z-index:1001; box-shadow:0 4px 15px rgba(0,0,0,0.2);}
    .chatbot-container { position:fixed; bottom:90px; right:20px; width:360px; height:480px; background: var(--white); border-radius:16px; box-shadow:0 6px 25px rgba(0,0,0,0.3); display:none; flex-direction:column; overflow:hidden; z-index:1002;}
    .chat-header { background: var(--primary-color); color:white; text-align:center; padding:1rem; font-weight:600; }
    .chat-body { flex:1; padding:0.8rem; overflow-y:auto; display:flex; flex-direction:column; gap:0.5rem;}
    .chat-msg { padding:0.6rem 1rem; border-radius:12px; max-width:80%; word-wrap:break-word;}
    .bot-msg { background:#E0F2FE; align-self:flex-start; }
    .user-msg { background:#DCFCE7; align-self:flex-end; }
    .chat-input { display:flex; border-top:1px solid #E5E7EB; }
    .chat-input input { flex:1; border:none; padding:0.8rem; outline:none; }
    .chat-input button { border:none; background: var(--primary-color); color:white; padding:0 1rem; cursor:pointer; }

    footer { background: var(--white); text-align:center; padding:1.5rem; margin-top:2rem; box-shadow:0 -2px 6px rgba(0,0,0,0.06);}
    footer p { color:#4B5563; font-size:0.95rem; }

  </style>
</head>

<body>

  <!-- Navbar -->
  <nav>
    <h1>üõèÔ∏è BedMatrix</h1>
    <ul>
      <li><a href="#home">Home</a></li>
      <li><a href="#features">Features</a></li>
      <li><a href="#dashboard">Dashboard</a></li>
      <li><a href="#faq">FAQ</a></li>
      <li><a href="#login">Login</a></li>
      <li><a href="#map-section">Map</a></li>
      <li><a href="#blood-bank-section">Blood Banks</a></li>
    </ul>
  </nav>

  <!-- Hero -->
  <section class="hero" id="home">
    <h2>Real-Time Hospital Bed Availability</h2>
    <p>Find available beds in General, ICU, Emergency, and Operation wards instantly. Your healthcare decisions simplified.</p>
  </section>

  <!-- Features -->
  <section class="features-section" id="features">
    <h2 class="section-title">Key Features</h2>
    <div class="features-grid">
      <div class="feature-card">
        <img src="https://cdn-icons-png.flaticon.com/512/2966/2966327.png" class="feature-icon" alt="real-time" />
        <h3 class="feature-title">Real-Time Availability</h3>
        <p class="feature-desc">Instant bed updates across all wards.</p>
      </div>
      <div class="feature-card">
        <img src="https://cdn-icons-png.flaticon.com/512/483/483356.png" class="feature-icon" alt="search" />
        <h3 class="feature-title">Search & Filter</h3>
        <p class="feature-desc">Find hospitals by name, ward, or availability.</p>
      </div>
      <div class="feature-card">
        <img src="https://cdn-icons-png.flaticon.com/512/942/942799.png" class="feature-icon" alt="admin" />
        <h3 class="feature-title">Admin Dashboard</h3>
        <p class="feature-desc">Securely update bed records.</p>
      </div>
      <div class="feature-card">
        <img src="https://cdn-icons-png.flaticon.com/512/190/190411.png" class="feature-icon" alt="alerts" />
        <h3 class="feature-title">Smart Alerts</h3>
        <p class="feature-desc">Color-coded bed availability status.</p>
      </div>

      <!-- NEW: Blood Bank Locator feature card -->
      <div class="feature-card">
        <img src="https://cdn-icons-png.flaticon.com/512/1048/1048953.png" class="feature-icon" alt="blood-bank" />
        <h3 class="feature-title">Blood Bank Locator</h3>
        <p class="feature-desc">Find nearest blood banks and check available blood groups instantly.</p>
      </div>
    </div>
  </section>

  <!-- Dashboard -->
  <section class="dashboard" id="dashboard">
    <h2 class="section-title">Live Bed Dashboard</h2>
    <table>
      <thead>
        <tr>
          <th>Hospital</th><th>General</th><th>Emergency</th><th>ICU</th><th>Operation</th><th>Status</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>AIIMS</td><td>25/50</td><td>8/15</td><td>2/10</td><td>1/5</td><td><span class="status fewleft">Few Left</span></td>
        </tr>
        <tr>
          <td>Fortis</td><td>10/40</td><td>2/10</td><td>1/5</td><td>0/5</td><td><span class="status available">Available</span></td>
        </tr>
      </tbody>
    </table>
  </section>

  <!-- FAQ -->
  <section class="faq-section" id="faq">
    <h2 class="section-title">Frequently Asked Questions (FAQ)</h2>
    <p class="faq-intro">Hover over each question to reveal the answer instantly.</p>
    <div class="faq-container">
      <div class="faq-item"><div class="faq-question">üîπ What is BedMatrix?</div><div class="faq-answer">BedMatrix is a real-time hospital and blood bank tracking platform that helps users find available beds and blood units across Delhi instantly.</div></div>
      <div class="faq-item"><div class="faq-question">üîπ How does BedMatrix show live data?</div><div class="faq-answer">Hospitals and blood banks update their data through the secure BedMatrix Admin Dashboard, ensuring accurate live availability.</div></div>
      <div class="faq-item"><div class="faq-question">üîπ Can I find the nearest hospital or blood bank?</div><div class="faq-answer">Yes! The BedMatrix map and chatbot help you find the nearest hospital or blood bank using your location.</div></div>
      <div class="faq-item"><div class="faq-question">üîπ How can I check available blood groups?</div><div class="faq-answer">Visit the Blood Bank section or hover over the red map markers to see available blood groups like A+, B+, O+, etc.</div></div>
      <div class="faq-item"><div class="faq-question">üîπ Is my personal data safe?</div><div class="faq-answer">Yes, BedMatrix never stores or shares personal or location data. Your privacy is fully protected.</div></div>
      <div class="faq-item"><div class="faq-question">üîπ Does BedMatrix work on mobile devices?</div><div class="faq-answer">Absolutely! BedMatrix is fully responsive and optimized for phones, tablets, and desktops.</div></div>
      <div class="faq-item"><div class="faq-question">üîπ Who can access the Admin Dashboard?</div><div class="faq-answer">Only verified hospital and government staff can log into the Admin Dashboard to manage bed and blood availability.</div></div>
    </div>
  </section>
  <!-- Accordion Animation Script -->
<script>
  // FAQ accordion open/close animation
  document.querySelectorAll('.faq-question').forEach((question) => {
    question.addEventListener('click', () => {
      const answer = question.nextElementSibling;
      const isActive = answer.style.display === 'block';
      // Close all
      document.querySelectorAll('.faq-answer').forEach(a => a.style.display = 'none');
      // Open current
      answer.style.display = isActive ? 'none' : 'block';
      question.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });
  });
</script>


  <!-- Login Section -->
  <ion id="login">
  <h2 class="section-title">Login</h2>

  <div class="login-tabs" style="display:flex; justify-content:center; gap:2rem; margin-bottom:1.5rem;">
    <button onclick="showLogin('user')" id="user-btn" style="padding:0.8rem 2rem; border:none; border-radius:8px; background:var(--primary-color); color:white; cursor:pointer;">User Login</button>
    <button onclick="showLogin('official')" id="official-btn" style="padding:0.8rem 2rem; border:none; border-radius:8px; background:#E5E7EB; color:var(--text-dark); cursor:pointer;">Official Login</button>
  </div>

  <!-- User Login Form -->
  <form class="login-form" id="user-login" style="display:block;">
    <p style="margin-bottom:1rem;">Welcome!<br>Enter your details to login or sign up</p>
    <input type="text" placeholder="Phone Number or Gmail" required />
    <button type="button">Send OTP</button>
  </form>

  <!-- Official Login Form -->
  <form class="login-form" id="official-login" style="display:none;">
    <p style="margin-bottom:1rem;">Login with your employee credentials</p>
    <input type="text" placeholder="Employee ID" required />
    <input type="password" placeholder="Password" required />
    <a href="#" style="font-size:0.85rem; color:var(--primary-color); text-decoration:none; display:block; margin-bottom:0.5rem;">Forgot Password?</a>
    <button type="submit">Login</button>
  </form>
</section>

<script>
  function showLogin(type){
    const userForm = document.getElementById('user-login');
    const officialForm = document.getElementById('official-login');
    const userBtn = document.getElementById('user-btn');
    const officialBtn = document.getElementById('official-btn');

    if(type==='user'){
      userForm.style.display='block';
      officialForm.style.display='none';
      userBtn.style.background= 'var(--primary-color)';
      userBtn.style.color='white';
      officialBtn.style.background='#E5E7EB';
      officialBtn.style.color='var(--text-dark)';
    } else {
      userForm.style.display='none';
      officialForm.style.display='block';
      officialBtn.style.background= 'var(--primary-color)';
      officialBtn.style.color='white';
      userBtn.style.background='#E5E7EB';
      userBtn.style.color='var(--text-dark)';
    }
  }
</script>
  <!-- Search & Filter Panel -->
  <section class="search-panel" id="search-panel" aria-label="Search and filter hospitals">
    <div class="controls">
      <input id="search-input" class="search-input" type="search" placeholder="Search hospitals by name..." aria-label="Search hospitals by name" />

      <div class="filters">
        <div class="filter-group">
          <label class="filter-label" for="ward-select">Ward</label>
          <select id="ward-select" aria-label="Filter by ward">
            <option value="any">Any</option>
            <option value="General">General</option>
            <option value="ICU">ICU</option>
            <option value="Emergency">Emergency</option>
            <option value="Operation">Operation</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label" for="availability-select">Availability</label>
          <select id="availability-select" aria-label="Filter by availability">
            <option value="any">Any</option>
            <option value="available">Available (&gt;10 total)</option>
            <option value="few">Few Left (3‚Äì10)</option>
            <option value="full">Full (&le;2)</option>
          </select>
        </div>

        <div class="filter-group">
          <label style="visibility:hidden">reset</label>
          <button id="reset-filters" class="btn" aria-label="Reset filters">Reset</button>
        </div>
      </div>
    </div>

    <div class="list-and-map">
      <!-- Hospital list -->
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.6rem;">
          <div style="font-weight:600;color:var(--text-gray)">Hospitals</div>
          <div id="result-count" style="color:var(--text-gray)">Showing 0</div>
        </div>
        <div class="hospital-list" id="hospital-list" aria-live="polite"></div>
      </div>
   
      <!-- Map -->
      <div id="map" role="region" aria-label="Delhi hospitals and blood banks map"></div>
    </div>
  </section>

  <!-- Blood Banks Table -->
  <section id="blood-bank-section">
    <h2 style="text-align:center; margin-top:0.5rem;">ü©∏ Nearby Blood Banks</h2>
    <p style="text-align:center; color:#4B5563; max-width:760px; margin:0.5rem auto 1rem;">
      Find your nearest blood banks and check which blood groups are currently available. Click a row to center the map on that blood bank.
    </p>

    <table style="width:90%; max-width:940px; margin:0 auto 3rem; border-collapse:collapse; box-shadow:0 4px 20px rgba(0,0,0,0.05);">
      <thead>
        <tr style="background:var(--primary-color); color:white;">
          <th style="padding:0.9rem;">Blood Bank</th>
          <th style="padding:0.9rem;">Location</th>
          <th style="padding:0.9rem;">Available Blood Groups</th>
        </tr>
      </thead>
      <tbody id="blood-bank-table"></tbody>
    </table>
  </section>

  <!-- Chatbot -->
  <button class="chatbot-toggle" onclick="toggleChatbot()" title="Open chat">üí¨</button>
  <div class="chatbot-container" id="chatbot" aria-hidden="true">
    <div class="chat-header">ü©∫ BedMatrix Assistant</div>
    <div class="chat-body" id="chat-body">
      <div class="chat-msg bot-msg">Hello! üëã I‚Äôm your BedMatrix assistant. Ask about nearest hospital, emergency beds, or blood bank availability.</div>
    </div>
    <div class="chat-input">
      <input type="text" id="user-input" placeholder="Try: 'Nearest blood bank' or 'Is O+ available?'" />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <footer>
    <p>¬© <span id="year"></span> BedMatrix ‚Äî demo UI. For production, wire to live APIs and secure admin access.</p>
  </footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // small init
    document.getElementById('year').textContent = new Date().getFullYear();

    // ===== Map initialization =====
    const map = L.map('map', { zoomControl: true }).setView([28.6139, 77.2090], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

    // SAMPLE hospitals (now include wards for filtering)
    const hospitals = [
      { id:'H1', name: "AIIMS Hospital", lat:28.5672, lon:77.2100, contact:"+91-11-2658-8500", wards:{General:25, ICU:2, Emergency:8, Operation:1} },
      { id:'H2', name: "Fortis Hospital", lat:28.5562, lon:77.1000, contact:"+91-11-4123-4567", wards:{General:10, ICU:1, Emergency:2, Operation:0} },
      { id:'H3', name: "Safdarjung Hospital", lat:28.5675, lon:77.2097, contact:"+91-11-2610-3284", wards:{General:4, ICU:0, Emergency:1, Operation:0} },
      { id:'H4', name: "Max Healthcare", lat:28.6280, lon:77.2180, contact:"+91-11-4286-1000", wards:{General:6, ICU:3, Emergency:1, Operation:2} }
    ];

    // create marker layer group & refs
    const hospitalLayer = L.layerGroup().addTo(map);
    const hospitalMarkers = {}; // id -> marker

    hospitals.forEach(h => {
      const popup = `<b>${h.name}</b><br>Contact: ${h.contact}<br>
                     <small>General: ${h.wards.General} ‚Ä¢ ICU: ${h.wards.ICU} ‚Ä¢ Emergency: ${h.wards.Emergency} ‚Ä¢ Operation: ${h.wards.Operation}</small>`;
      const m = L.marker([h.lat, h.lon]).bindPopup(popup);
      hospitalMarkers[h.id] = m;
      hospitalLayer.addLayer(m);
    });

    // Blood banks (unchanged)
    const bloodBanks = [
      { id: 'B1', name: "Delhi Red Cross Blood Bank", lat: 28.5740, lon: 77.2070, location: "Central Delhi", contact: "+91-11-2334-0001", groups: ["A+", "B+", "O+", "AB+", "O-", "A-"] },
      { id: 'B2', name: "AIIMS Blood Bank", lat: 28.5678, lon: 77.2105, location: "Ansari Nagar", contact: "+91-11-2658-1234", groups: ["A+", "O+", "B-", "AB-"] },
      { id: 'B3', name: "Fortis Blood Bank", lat: 28.5565, lon: 77.1012, location: "Okhla", contact: "+91-11-4123-9999", groups: ["A+", "O+", "B+", "O-"] },
      { id: 'B4', name: "Apollo Blood Bank", lat: 28.5445, lon: 77.2693, location: "South Delhi", contact: "+91-11-2666-7777", groups: ["A+", "B+", "O+", "A-", "B-"] }
    ];
    const bloodBankMarkers = {};
    bloodBanks.forEach(b => {
      const marker = L.circleMarker([b.lat, b.lon], { radius:9, color:"#EF4444", weight:2, fillColor:"#FCA5A5", fillOpacity:0.9 }).addTo(map);
      const popupHtml = `<div style="font-weight:600;">${b.name}</div>
                         <div style="margin-top:6px;"><b>Location:</b> ${b.location}</div>
                         <div style="margin-top:6px;"><b>Contact:</b> ${b.contact}</div>
                         <div style="margin-top:6px;"><b>Available:</b> ${b.groups.join(", ")}</div>`;
      marker.bindPopup(popupHtml);
      bloodBankMarkers[b.id] = marker;
    });

    // Populate blood bank table (click to open)
    const tableBody = document.getElementById('blood-bank-table');
    bloodBanks.forEach(b => {
      const tr = document.createElement('tr');
      tr.style.cursor = 'pointer';
      tr.innerHTML = `<td style="padding:0.8rem; border-bottom:1px solid #E5E7EB; text-align:left">${b.name}</td>
                      <td style="padding:0.8rem; border-bottom:1px solid #E5E7EB">${b.location}</td>
                      <td style="padding:0.8rem; border-bottom:1px solid #E5E7EB">${b.groups.join(", ")}</td>`;
      tr.addEventListener('click', () => {
        map.setView([b.lat, b.lon], 14, { animate: true });
        bloodBankMarkers[b.id].openPopup();
      });
      tableBody.appendChild(tr);
    });

    // Legend
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function(map) {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
        <div style="padding:8px; border-radius:8px; background:white; box-shadow:0 4px 10px rgba(0,0,0,0.06)">
          <div style="font-weight:600; margin-bottom:6px;">Map Legend</div>
          <div style="display:flex;align-items:center;gap:8px;"><svg width="12" height="12"><circle cx="6" cy="6" r="6" fill="#0074D9"/></svg><span>Hospitals</span></div>
          <div style="display:flex;align-items:center;gap:8px;margin-top:6px"><svg width="12" height="12"><circle cx="6" cy="6" r="6" fill="#EF4444"/></svg><span>Blood Banks</span></div>
        </div>`;
      return div;
    };
    legend.addTo(map);

    // ---------------- Search & Filter Logic ----------------
    const input = document.getElementById('search-input');
    const wardSelect = document.getElementById('ward-select');
    const availabilitySelect = document.getElementById('availability-select');
    const resetBtn = document.getElementById('reset-filters');
    const listEl = document.getElementById('hospital-list');
    const countEl = document.getElementById('result-count');

    function totalBeds(h){ return Object.values(h.wards).reduce((a,b)=>a+b,0); }
    function statusClass(h){
      const t = totalBeds(h);
      if(t > 10) return 'available';
      if(t >= 3) return 'fewleft';
      return 'full';
    }

    function renderList(arr){
      listEl.innerHTML = '';
      if(arr.length === 0){
        listEl.innerHTML = '<div style="color:#64748B;padding:12px">No hospitals match your filters.</div>';
        countEl.textContent = 'Showing 0';
        return;
      }
      countEl.textContent = `Showing ${arr.length}`;
      arr.forEach(h => {
        const div = document.createElement('div');
        div.className = 'h-card';
        div.dataset.id = h.id;
        div.innerHTML = `
          <div class="h-left">
            <div class="h-name">${h.name}</div>
            <div class="h-wards">Gen: ${h.wards.General} ‚Ä¢ ICU: ${h.wards.ICU} ‚Ä¢ EMG: ${h.wards.Emergency} ‚Ä¢ Op: ${h.wards.Operation}</div>
          </div>
          <div class="h-right"><div class="h-status ${statusClass(h)}">${statusClass(h) === 'available' ? 'Available' : statusClass(h) === 'fewleft' ? 'Few Left' : 'Full'}</div></div>
        `;
        div.addEventListener('click', () => {
          map.setView([h.lat, h.lon], 14, { animate:true });
          hospitalMarkers[h.id].openPopup();
        });
        listEl.appendChild(div);
      });
    }

    function applyFilters(){
      const q = (input.value || '').trim().toLowerCase();
      const ward = wardSelect.value;
      const avail = availabilitySelect.value;

      let out = hospitals.filter(h => h.name.toLowerCase().includes(q));

      if(ward !== 'any'){
        out = out.filter(h => (h.wards[ward] || 0) > 0);
      }

      if(avail !== 'any'){
        out = out.filter(h => {
          const t = totalBeds(h);
          if(avail === 'available') return t > 10;
          if(avail === 'few') return t >= 3 && t <= 10;
          if(avail === 'full') return t <= 2;
          return true;
        });
      }

      // update markers: clear layer then add matched
      hospitalLayer.clearLayers();
      out.forEach(h => hospitalLayer.addLayer(hospitalMarkers[h.id]));

      renderList(out);
    }

    // debounce helper
    function debounce(fn, wait){
      let t;
      return function(...args){ clearTimeout(t); t = setTimeout(()=> fn.apply(this,args), wait); };
    }

    // initial render
    applyFilters();

    // events
    input.addEventListener('input', debounce(applyFilters, 180));
    wardSelect.addEventListener('change', applyFilters);
    availabilitySelect.addEventListener('change', applyFilters);
    resetBtn.addEventListener('click', () => {
      input.value = '';
      wardSelect.value = 'any';
      availabilitySelect.value = 'any';
      applyFilters();
    });

    // -------------- Chatbot (kept same) --------------
    const chatbot = document.getElementById('chatbot');
    const chatBody = document.getElementById('chat-body');
    const userInput = document.getElementById('user-input');

    function toggleChatbot(){ 
      const isHidden = chatbot.style.display !== 'flex';
      chatbot.style.display = isHidden ? 'flex' : 'none';
      chatbot.setAttribute('aria-hidden', !isHidden);
    }

    function addMessage(msg, sender){
      const div = document.createElement('div');
      div.classList.add('chat-msg', sender==='bot' ? 'bot-msg' : 'user-msg');
      div.textContent = msg;
      chatBody.appendChild(div);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function sendMessage(){
      const raw = userInput.value.trim();
      if(!raw) return;
      addMessage(raw, 'user');
      userInput.value = '';
      setTimeout(()=> botReply(raw), 350);
    }

    // Haversine & helper functions (same as previous)
    function haversine(lat1, lon1, lat2, lon2){
      function toRad(x){ return x * Math.PI / 180; }
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function findNearestBloodBank(lat, lon){
      let min = Infinity; let nearest = null;
      bloodBanks.forEach(b => {
        const d = haversine(lat, lon, b.lat, b.lon);
        if(d < min){ min = d; nearest = { bank: b, distance: d }; }
      });
      return nearest;
    }

    function banksWithGroup(group){
      const normalized = group.toUpperCase().replace(/\s+/g,'');
      return bloodBanks.filter(b => b.groups.map(g=>g.toUpperCase()).includes(normalized));
    }

    function replyWithNearestBloodBank(){
      if(!navigator.geolocation){
        addMessage("Geolocation not available. Please type a city or landmark.", 'bot'); return;
      }
      addMessage("Requesting your location to find the nearest blood bank... (allow location)", 'bot');
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude; const lon = pos.coords.longitude;
        const nearest = findNearestBloodBank(lat, lon);
        if(!nearest){ addMessage("No blood banks found in our data.", 'bot'); return; }
        const b = nearest.bank; const dKm = nearest.distance.toFixed(2);
        addMessage(`Nearest blood bank: ${b.name} (${b.location}) ‚Äî approx ${dKm} km away. Available: ${b.groups.join(", ")}`, 'bot');
        map.setView([b.lat, b.lon], 14, { animate: true }); bloodBankMarkers[b.id].openPopup();
      }, err => {
        addMessage("Location access denied or failed. Please allow location access or ask by name.", 'bot');
      }, { enableHighAccuracy:true, timeout:10000, maximumAge:60000 });
    }
    const HEALTHCARE_KEYWORDS = [
  "hospital",
  "bed",
  "icu",
  "emergency",
  "blood",
  "blood bank",
  "donation",
  "ambulance",
  "health",
  "medical",
  "doctor",
  "patient",
  "ward"
];


    // bot reply (kept short)
    async function botReply(rawInput) {
  const input = (rawInput || "").toLowerCase();

  // üöß DOMAIN GUARD: healthcare-only
const isHealthcareQuery = HEALTHCARE_KEYWORDS.some(keyword =>
  input.includes(keyword)
);

if (!isHealthcareQuery) {
  addMessage(
    "ü©∫ I‚Äôm designed to help with healthcare-related questions only ‚Äî such as hospitals, bed availability, emergencies, or blood banks. Please ask something related to healthcare.",
    "bot"
  );
  return;
}



  /* ===============================
     RULE-BASED (FAST & PRECISE)
     =============================== */

  // Nearest blood bank
  if (
    input.includes("nearest blood") ||
    input.includes("nearest blood bank") ||
    input.includes("closest blood")
  ) {
    replyWithNearestBloodBank();
    return;
  }

  // Blood group availability (A+, O-, etc.)
  const groupMatch = rawInput.match(/(a\+|a-|b\+|b-|o\+|o-|ab\+|ab-)/i);
  if (groupMatch) {
    const group = groupMatch[0].toUpperCase();
    const banks = banksWithGroup(group);

    if (banks.length === 0) {
      addMessage(`No blood banks currently list ${group}.`, "bot");
    } else {
      addMessage(
        `${group} is available at: ${banks
          .map((b) => `${b.name} (${b.location})`)
          .join("; ")}`,
        "bot"
      );
      map.setView([banks[0].lat, banks[0].lon], 14);
      bloodBankMarkers[banks[0].id].openPopup();
    }
    return;
  }

  // Nearest hospital
  if (input.includes("nearest hospital") || input.includes("nearby hospital")) {
    if (!navigator.geolocation) {
      addMessage("Geolocation unavailable. Please search manually.", "bot");
      return;
    }

    addMessage("Locating nearest hospital... (allow location)", "bot");

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        let min = Infinity;
        let nearest = null;

        hospitals.forEach((h) => {
          const d = haversine(lat, lon, h.lat, h.lon);
          if (d < min) {
            min = d;
            nearest = { h, d };
          }
        });

        if (nearest) {
          addMessage(
            `Nearest hospital: ${nearest.h.name} (~${nearest.d.toFixed(
              2
            )} km). Contact: ${nearest.h.contact}`,
            "bot"
          );
          map.setView([nearest.h.lat, nearest.h.lon], 14);
          hospitalMarkers[nearest.h.id].openPopup();
        } else {
          addMessage("No hospitals found.", "bot");
        }
      },
      () => addMessage("Location access denied.", "bot"),
      { enableHighAccuracy: true, timeout: 10000 }
    );
    return;
  }

  /* ===============================
     AI FALLBACK (SMART & FLEXIBLE)
     =============================== */

  addMessage("Typing...", "bot");

  try {
    const res = await fetch("http://localhost:3000/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: rawInput }),
    });

    const data = await res.json();

    // remove "Typing..."
    chatBody.removeChild(chatBody.lastChild);

    addMessage(data.reply, "bot");
  } catch (err) {
    chatBody.removeChild(chatBody.lastChild);
    addMessage("‚ö†Ô∏è AI backend not reachable", "bot");
  }
}


    
    document.getElementById('user-input').addEventListener('keydown', function(e){ if(e.key==='Enter') sendMessage(); });

    
    window.sendMessage = sendMessage;
    window.toggleChatbot = toggleChatbot;

  </script>

</body>
</html>